service: realty-bot
frameworkVersion: '3'
configValidationMode: error
useDotenv: true

provider:
    name: aws
    runtime: nodejs18.x
    region: ${env:AWS_REGION}
    versionFunctions: false
    stage: dev
    environment:
        TG_BOT_TOKEN: ${env:TG_BOT_TOKEN}
        YA_TOKEN: ${env:YA_TOKEN}
        ADMIN_CHAT_ID: ${env:ADMIN_CHAT_ID}
        APP_ENV: ${opt:stage, self:provider.stage}
        AWS_PROJECT_ACCESS_KEY_ID: ${env:AWS_ACCESS_KEY_ID}
        AWS_PROJECT_SECRET_ACCESS_KEY: ${env:AWS_SECRET_ACCESS_KEY}
        AWS_PROJECT_REGION: ${env:AWS_REGION}

package:
    patterns:
        - '!src/**'
        - '!tests/**'
        - '!.dynamodb/**'
        - '!.github/**'
        - '!.idea/**'
        - '!config/**'
        - '!jest.config.ts'
        - '!*.json'
        - '!readme.md'

plugins:
    - serverless-dynamodb-local
    - serverless-offline
    - serverless-express

resources:
    - ${file(config/resources.yml)}

functions:
    link:
        handler: dist/handler/link.handle
        events:
            -   http:
                    method: get
                    path: /link
    webhook:
        handler: dist/handler/webhook.handle
        timeout: 30
        events:
            -   http:
                    method: post
                    path: /webhook
    monitor:
        handler: dist/handler/monitor.handle
        timeout: 300
        events:
            -   schedule: rate(5 minutes)
            -   http:
                    method: get
                    path: /monitor

custom:
    dynamodb:
        stages:
            - test
        start:
            migrate: true